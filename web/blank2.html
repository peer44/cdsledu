<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Dashboard</title>
    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="vendor/toastr/toastr.css" rel="stylesheet">
    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.css" rel="stylesheet">
</head>

<body id="page-top">
<div id="wrapper">
    <!-- 左侧菜单开始 -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3" id="productName">SB Admin <sup>2</sup></div>
        </a>
        <!-- 一个占位符 -->
        <li class="nav-item active" id='postionHave'>
            <a class="nav-link" href="index.html">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>Dashboard</span></a>
        </li>
        <!-- Sidebar Toggler (Sidebar) -->
        <!-- <div class="text-center d-none d-md-inline">
          <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div> -->
    </ul>
    <!-- 左侧菜单结束 -->
    <div id="content-wrapper" class="d-flex flex-column">

        <!-- Main Content -->
        <div id="content">
            <!-- 顶部信息 -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow" id="top"></nav>
            <!-- 顶部信息 -->

            <!-- 页面内容 -->

            <div class="card-header py-3 text-red">
                请选择就读方式：
                <input type="radio" name="jdfs" id="rents" value="rents" checked> 居住就读
                <input type="radio" name="jdfs" id="points" value="points"> 积分就读
            </div>

            <div class="container-fluid">

                <!-- Page Heading -->
                <table class="table" id="studentTable">
                    <tbody>
                    <tr>
                        <td>证件持有人姓名</td>
                        <td><input name="guarder" id="guarder"/></td>
                        <td>证件持有人身份证</td>
                        <td><input name="guarderId" id="guarderId"/></td>
                        <td>联系电话</td>
                        <td><input name="telephone" id="telephone"/></td>
                    </tr>

                    <tr>
                        <td>证件类别</td>
                        <td>
                            <input type="radio" name="idType" id="jzz" value="jzz" checked> 居住证
                            <input type="radio" name="idType" id="jzdjzm" value="jzdjzm"> 居住登记证明
                        </td>
                        <td>证件编码</td>
                        <td><input name="jzzid" id="jzzid"/></td>
                        <td>证件住址</td>
                        <td><input type="text" name="idAddress" id="idAddress"/></td>
                    </tr>

                    <tr id="rent">
                        <td>人员类型</td>
                        <td>
                            <input type="radio" name="workType" id="dwzg" value="dwzg" checked> 单位职工
                            <input type="radio" name="workType" id="gtgsh" value="gtgsh"> 个体工商户
                        </td>
                        <td>租房备案号</td>
                        <td><input name="rentNum" id="rentNum"/></td>
                        <td>住址所属社区</td>
                        <td>
                            <select id="town" required>
                                <option value="">--请选择--</option>
                            </select>
                            <select id="village" required>
                                <option value="">--请选择--</option>
                            </select>
                        </td>

                    </tr>

                    <tr id="company">
                        <td>单位名称</td>
                        <td><input name="companyName" id="companyName"/></td>
                        <td>单位地址</td>
                        <td><input name="companyAddress" id="companyAddress"/></td>
                        <td>社会信用代码</td>
                        <td><input name="companyId" id="companyId"/></td>
                    </tr>

                    <tr id="point">
                        <td>居住积分</td>
                        <td>
                            <select id="live_point" onchange="point()">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </td>
                        <td>社保积分</td>
                        <td>
                            <select id="social_point" onchange="point()">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select></td>
                        <td>总积分</td>
                        <td>
                            <input type="text" name="score" id="total_point" placeholder="0" onblur="point()" checked>
                        </td>
                    </tr>

                    <tr>
                        <td>社保编码</td>
                        <td><input name="socialId" id="socialId"/></td>
                        <td>缴纳方式</td>
                        <td>
                            <input type="radio" name="payMethod" id="dw" value="dw" checked> 单位
                            <input type="radio" name="payMethod" id="gr" value="gr"> 个人
                        </td>
                        <td>学生姓名</td>
                        <td><input type="text" name="xsName" id="xsName"/></td>

                    </tr>

                    <tr>
                        <td>学生身份证</td>
                        <td><input type="text" name="xsId" id="xsId"/></td>
                        <td>学生性别</td>
                        <td>
                            <input type="radio" name="xsGender" value="male" checked> 男
                            <input type="radio" name="xsGender" value="female"> 女
                        </td>
                        <td>申请入学年级</td>
                        <td>
                            <select class="custom-select" id="grade" required>
                                <option value="">--请选择--</option>
                                <option value="一年级">一年级</option>
                                <option value="二年级">二年级</option>
                                <option value="三年级">三年级</option>
                                <option value="四年级">四年级</option>
                                <option value="五年级">五年级</option>
                                <option value="六年级">六年级</option>
                                <option value="七年级">七年级</option>
                                <option value="八年级">八年级</option>
                                <option value="九年级">九年级</option>
                            </select>
                        </td>

                    </tr>

                    <tr>
                        <td>学籍号</td>
                        <td><input name="xjh" id="xjh"/></td>
                        <td>户籍地址</td>
                        <td colspan="3">
                            <div id="target" data-toggle="distpicker">
                                <select data-province="四川省" id="provinceName"></select>
                                <select data-city="成都市" id="cityName"></select>
                                <select data-district="双流区" id="districtName"></select>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>备注</td>
                        <td colspan="5"><label>
                            <textarea name="bz" id="bz" style="width:500%" maxlength="30"></textarea>
                        </label></td>
                    </tr>
                    <tr id="last">
                        <td align="center" colspan="6">
                            <button class="btn btn-primary" type="submit" id="submit" style="width: 15%">提交</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 页面内容 -->
        </div>

        <!-- 尾部信息 -->
        <footer class="sticky-footer bg-white" id="footer">
        </footer>
        <!-- 尾部信息 -->
    </div>

</div>
<!-- Bootstrap core JavaScript-->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="vendor/toastr/toastr.min.js"></script>
<!--<script src="vendor/jquery-validation/jquery.validate.js"></script>
<script src="vendor/jquery-validation/messages_zh.js"></script>-->
<!-- Custom scripts for all pages-->
<script src="js/sb-admin-2.min.js"></script>

<!-- Page level custom scripts -->
<script src="js/config.js"></script>
<script src="js/common.js"></script>
<script src="js/user-info-menu.js"></script>
<script src="js/distpicker.js"></script>

<script type="text/javascript">

    // 省市区联动
    $("#target").distpicker({
        autoSelect: true,
        placeholder: false
    })

    // 加载住址所属社区数据联动
    $.ajax({
        url: window.config.api + '/system/getDistrict',
        method: "GET",
        async: false,
        success: function (response) {
            console.info(response);
            for (let i = 0; i < response.data.length; i++) {
                $("#town").append($("<option data-value=" + response.data[i].name + "></option>").val(i + 1).html(response.data[i].name));
            }
            // 为省份下拉列表绑定change事件
            $("#town").change(function () {
                let index = $(this).val() - 1;// 获取当前省的下标
                $("#village").prop("length", 1);// 清空原有的数据
                if (response.data[index]) {
                    for (let i = 0; i < response.data[index].addresses.length; i++) {//重新为市赋值
                        $("#village").append($("<option data-value=" + response.data[index].addresses[i].name + "></option>").val(i + 1).html(response.data[index].addresses[i].name));
                    }
                }
            });
        }
    })

    // 根据id获取数据并绑定显示
    let id = getUrlParam("id");
    if (id) {
        $.ajax({
            url: window.config.api + '/enrollment/getCompulsoryById/' + id,
            method: "GET",
            success: function (response) {

                if (response.data.type == '2') {
                    $("#points").trigger("click");
                    $("#point").show();
                    $("#rent").hide();
                    $("#company").hide();
                } else {
                    $("#rents").trigger("click");
                    $("#point").hide();
                    $("#rent").show();
                    $("#company").show();
                }

                let view = getUrlParam("view");
                if (view) {
                    $(":input").attr("disabled", "disabled");
                    $("#last").hide();
                }

                $("#live_point").val(response.data.livePoint);
                $("#social_point").val(response.data.socialPoint);
                $("#total_point").val(response.data.totalPoint);

                console.info(response);
                $("#guarder").val(response.data.guarderName);
                $("#guarderId").val(response.data.guarderIdentityNumber);
                $("#telephone").val(response.data.telephone);
                if (response.data.residenceType == '居住证') {
                    $("input[name='idType'][value='jzz']").attr("checked", true);
                } else {
                    $("input[name='idType'][value='jzdjzm']").attr("checked", true);
                }
                $("#jzzid").val(response.data.residenceNumber);
                $("#idAddress").val(response.data.residenceAddress);
                if (response.data.guarderType == '单位职工') {
                    $("input[name='workType'][value='dwzg']").attr("checked", true);
                } else {
                    $("input[name='workType'][value='gtgsh']").attr("checked", true);
                }
                $("#rentNum").val(response.data.rentNumber);
                $("#companyName").val(response.data.company);
                $("#companyAddress").val(response.data.companyAddress);
                $("#companyId").val(response.data.companySocialId);
                $("#socialId").val(response.data.socialSecurityId);
                if (response.data.socialSecurityPayMethod == '单位') {
                    $("input[name='payMethod'][value='dw']").attr("checked", true);
                } else {
                    $("input[name='payMethod'][value='gr']").attr("checked", true);
                }
                $("#xsName").val(response.data.studentName);
                $("#xsId").val(response.data.studentIdentityNumber);
                if (response.data.studentGender == '男') {
                    $("input[name='xsGender'][value='male']").attr("checked", true);
                } else {
                    $("input[name='xsGender'][value='female']").attr("checked", true);
                }
                $("#grade").find("option:contains(" + response.data.studentGrade + ")").attr("selected", true);
                $("#xjh").val(response.data.studentSchoolRoll);
                $("#bz").val(response.data.comment);
                let addr = response.data.studentHousehold.split("|");
                $("#provinceName").val(addr[0]);
                $("#provinceName").trigger("change");
                $("#cityName").val(addr[1]);
                $("#cityName").trigger("change");
                $("#districtName").val(addr[2]);
                $("#districtName").trigger("change");

                let zone = response.data.rentAddressZone.split("|");
                $("#town option").each(function () {
                    let val = $(this).val();
                    let text = $(this).attr('data-value');
                    console.info(text);
                    if (text == zone[0]) {
                        $("#town").val(val);
                    }
                })
                $("#town").trigger("change");
                $("#village option").each(function () {
                    let val = $(this).val();
                    let text = $(this).attr('data-value');
                    console.info(text);
                    if (text == zone[1]) {
                        $("#village").val(val);
                    }
                })

            }
        });
    }

    function point() {
        let livePoint = $("#live_point").val();
        let socialPoint = $("#social_point").val();
        console.info("livePoint:" + livePoint);
        console.info("socialPoint:" + socialPoint);
        let total_point = livePoint * 1 + socialPoint * 1;
        $("#total_point").val(total_point);
    }

    $(document).ready(function () {
        $("#point").hide();
        $("input[type=radio][name=jdfs]").change(function () {
            if (this.value === "points") {
                $("#point").show();
                $("#rent").hide();
                $("#company").hide();
            } else if (this.value === "rents") {
                $("#point").hide();
                $("#rent").show();
                $("#company").show();
            }
        });
    });

    // 验证中文名称
    function isChinaName(name) {
        let pattern = /^[\u4E00-\u9FA5]{1,6}$/;
        return pattern.test(name);
    }

    // 验证手机号
    function isPhoneNo(phone) {
        let pattern = /^1[34578]\d{9}$/;
        return pattern.test(phone);
    }

    // 验证身份证
    function isCardNo(card) {
        let pattern = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
        return pattern.test(card);
    }

    // 验证函数
    function formValidate() {

        let type = $("input[type='radio'][name='jdfs']:checked").val();
        if (type === 'rents') {
            type = 1;
        } else {
            type = 2;
        }

        let str = '';

        // 判断名称
        if ($.trim($("#xsName").val()).length === 0) {
            str += '请输入学生姓名\n';
            $('#xsName').focus();
        } else {
            if (isChinaName($.trim($('#xsName').val())) === false) {
                str += '请输入合法的学生姓名\n';
                $('#xsName').focus();
            }
        }

        if ($.trim($("#guarder").val()).length === 0) {
            str += '请输入证件持有人姓名\n';
            $('#guarder').focus();
        } else {
            if (isChinaName($.trim($('#guarder').val())) === false) {
                str += '请输入合法的证件持有人姓名\n';
                $('#guarder').focus();
            }
        }

        // 判断手机号码
        if ($.trim($('#telephone').val()).length === 0) {
            str += '联系电话没有输入\n';
            $('#telephone').focus();
        } else {
            if (isPhoneNo($.trim($('#telephone').val()) === false)) {
                str += '请输入合法的联系电话\n';
                $('#telephone').focus();
            }
        }

        // 验证身份证
        if ($.trim($('#xsId').val()).length === 0) {
            str += '学生身份证号码没有输入\n';
            $('#xsId').focus();
        } else {
            if (isCardNo($.trim($('#xsId').val())) === false) {
                str += '学生身份证号不正确\n';
                $('#xsId').focus();
            }
        }

        if ($.trim($('#guarderId').val()).length === 0) {
            str += '证件持有人身份证号码没有输入\n';
            $('#guarderId').focus();
        } else {
            if (isCardNo($.trim($('#guarderId').val())) === false) {
                str += '证件持有人身份证号不正确\n';
                $('#guarderId').focus();
            }
        }

        // 验证地址
        if ($.trim($('#idAddress').val()).length === 0) {
            str += '请输入证件住址\n';
            $('#idAddress').focus();
        }
        if ($.trim($('#companyAddress').val()).length === 0) {
            if (type == 1) {
                str += '请输入单位地址\n';
                $('#companyAddress').focus();
            }
        }

        if (type == 1) {
            let town = $("#town").find("option:selected").data("value");
            let village = $("#village").find("option:selected").data("value");
            if (town == undefined || village == undefined) {
                str += '请选择住址所属社区\n';
            }
        }

        // 如果没有错误则提交
        if (str !== '') {
            alert(str);
            return false;
        } else {
            console.info("提交数据");

            // 就读方式：1居住就读，2积分就读
            let type = $("input[type='radio'][name='jdfs']:checked").val();
            if (type === 'rents') {
                type = 1;
            } else {
                type = 2;
            }
            let guarderName = $("#guarder").val();
            let guarderIdentityNumber = $("#guarderId").val();
            let telephone = $("#telephone").val();
            let residenceType = $("input[type='radio'][name='idType']:checked").val();
            if (residenceType === 'jzz') {
                residenceType = '居住证';
            } else {
                residenceType = '居住登记证明';
            }
            // 居住证件编码
            let residenceNumber = $("#jzzid").val();
            let residenceAddress = $("#idAddress").val();

            let guarderType = $("input[type='radio'][name='workType']:checked").val();
            if (guarderType === 'dwzg') {
                guarderType = '单位职工';
            } else {
                guarderType = '个体工商户';
            }
            let rentNumber = $("#rentNum").val();
            let rentAddressZone = $("#town").find("option:selected").data("value") + "|" + $("#village").find("option:selected").data("value");
            let livePoint = $("#live_point").val();
            let socialPoint = $("#social_point").val();
            let totalPoint = $("#total_point").val();
            let company = $("#companyName").val();
            let companyAddress = $("#companyAddress").val();
            let companySocialId = $("#companyId").val();
            let socialSecurityId = $("#socialId").val();
            let socialSecurityPayMethod = $("input[type='radio'][name='payMethod']:checked").val();
            if (socialSecurityPayMethod == 'dw') {
                socialSecurityPayMethod = '单位';
            } else {
                socialSecurityPayMethod = '个人';
            }
            let studentName = $("#xsName").val();
            let studentIdentityNumber = $("#xsId").val();
            let studentGender = $("input[type='radio'][name='xsGender']:checked").val();
            if (studentGender == 'male') {
                studentGender = '男'
            } else {
                studentGender = '女'
            }
            let studentGrade = $("#grade").val();
            let studentSchoolRoll = $("#xjh").val();
            let studentHousehold = $("#provinceName").val() + "|" + $("#cityName").val() + "|" + $("#districtName").val();
            let comment = $("#bz").val();
            console.info("id:" + id);
            console.info("就读方式：" + type);
            console.info("证件持有人姓名：" + guarderName)
            console.info("证件持有人身份证：" + guarderIdentityNumber)
            console.info("联系电话：" + telephone)
            console.info("居住证件类型：" + residenceType)
            console.info("居住证件编码：" + residenceNumber)
            console.info("居住证上所写住址：" + residenceAddress)
            console.info("人员类型：" + guarderType)
            console.info("租房备案号：" + rentNumber)
            console.info("住址所属社区：" + rentAddressZone)
            console.info("居住积分:" + livePoint)
            console.info("社保积分:" + socialPoint)
            console.info("总积分:" + totalPoint)
            console.info("单位名称:" + company)
            console.info("单位地址:" + companyAddress)
            console.info("单位社会信用代码:" + companySocialId)
            console.info("社保编码:" + socialSecurityId)
            console.info("社保缴纳方式:" + socialSecurityPayMethod)
            console.info("学生姓名:" + studentName)
            console.info("学生身份证号:" + studentIdentityNumber)
            console.info("学生性别:" + studentGender)
            console.info("申请入学年级:" + studentGrade)
            console.info("学籍号:" + studentSchoolRoll)
            console.info("户籍地址:" + studentHousehold)
            console.info("备注:" + comment)

            $.ajax({
                url: window.config.api + '/enrollment/addCompulsory',
                method: "POST",
                data: JSON.stringify({
                    "id": id,
                    "type": type,
                    "guarderName": guarderName,
                    "guarderIdentityNumber": guarderIdentityNumber,
                    "telephone": telephone,
                    "residenceType": residenceType,
                    "residenceNumber": residenceNumber,
                    "residenceAddress": residenceAddress,
                    "guarderType": guarderType,
                    "rentNumber": rentNumber,
                    "rentAddressZone": rentAddressZone,
                    "livePoint": livePoint,
                    "socialPoint": socialPoint,
                    "totalPoint": totalPoint,
                    "company": company,
                    "companyAddress": companyAddress,
                    "companySocialId": companySocialId,
                    "socialSecurityId": socialSecurityId,
                    "socialSecurityPayMethod": socialSecurityPayMethod,
                    "studentName": studentName,
                    "studentIdentityNumber": studentIdentityNumber,
                    "studentGender": studentGender,
                    "studentGrade": studentGrade,
                    "studentSchoolRoll": studentSchoolRoll,
                    "studentHousehold": studentHousehold,
                    "comment": comment
                }),
                success: function (response) {
                    if (response.errorCode == 200) {
                        toastr.success("提交成功");
                    }
                }
            });

        }
    }

    $('#submit').on('click', function () {
        formValidate();
    });
</script>

</body>

</html>